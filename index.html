<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—…ë¬´ ìŠ¤ì¼€ì¤„ëŸ¬</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #40c057; --primary-hover: #37b24d; --bg: #f1f3f5; --text: #212529; }
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px 15px 60px; }
        .container { max-width: 1300px; margin: 0 auto; }

        /* í—¤ë” */
        .page-header { text-align: center; padding: 22px 0 16px; }
        .page-header h1 { margin: 0; font-size: 26px; color: #2f9e44; font-weight: 800; letter-spacing: -0.5px; }
        .page-header p { margin: 5px 0 0; color: #868e96; font-size: 14px; }

        .card { background: white; border-radius: 12px; box-shadow: 0 4px 14px rgba(0,0,0,0.07); padding: 22px; margin-bottom: 18px; }
        h2 { margin: 0 0 16px 0; font-size: 17px; color: #495057; display: flex; align-items: center; gap: 9px; }

        /* ì„¤ì • ì¹´ë“œ */
        .config-card { background: #f8fff9; border: 2px dashed #b2f2bb; border-radius: 12px; padding: 18px 22px; margin-bottom: 18px; display: none; }
        .config-card.visible { display: block; }
        .config-card h2 { color: #2f9e44; margin-bottom: 12px; font-size: 15px; }
        .config-grid { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end; }
        .config-input { display: flex; flex-direction: column; gap: 5px; width: 100%; }
        .config-input label { font-size: 11px; font-weight: 700; color: #868e96; text-transform: uppercase; letter-spacing: 0.3px; }
        .config-input input { padding: 9px 13px; border: 1.5px solid #b2f2bb; border-radius: 8px; font-size: 14px; font-family: inherit; background: white; width: 100%; }
        .config-input input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(64,192,87,0.12); }
        .config-note { font-size: 12px; color: #868e96; margin-top: 8px; display: flex; align-items: flex-start; gap: 5px; }

        /* í¼ */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(175px, 1fr)); gap: 12px; margin-bottom: 12px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 12px; font-weight: 700; color: #868e96; text-transform: uppercase; letter-spacing: 0.3px; }
        input[type=text], input[type=date], textarea {
            padding: 10px 13px; border: 1.5px solid #dee2e6; border-radius: 8px;
            font-size: 14px; font-family: inherit; transition: border-color 0.2s;
            width: 100%; background: #fafafa;
        }
        input[type=text]:focus, input[type=date]:focus, textarea:focus {
            outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(64,192,87,0.12); background: #fff;
        }
        textarea { resize: vertical; }
        #submitBtn { background: var(--primary); color: white; border: none; padding: 13px; border-radius: 8px; font-weight: 700; cursor: pointer; width: 100%; font-size: 15px; transition: background 0.2s; margin-top: 4px; }
        #submitBtn:hover:not(:disabled) { background: var(--primary-hover); }
        #submitBtn:disabled { background: #adb5bd; cursor: not-allowed; }

        /* í† ìŠ¤íŠ¸ */
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(80px); background: #343a40; color: white; padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: 500; z-index: 9999; transition: transform 0.3s ease; pointer-events: none; white-space: nowrap; }
        #toast.show { transform: translateX(-50%) translateY(0); }
        #toast.success { background: #40c057; }
        #toast.error { background: #fa5252; }

        /* íˆ´ë°” */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
        .toolbar-btn { background: none; border: 1.5px solid #dee2e6; border-radius: 6px; padding: 6px 13px; font-size: 13px; cursor: pointer; color: #495057; transition: all 0.2s; font-family: inherit; }
        .toolbar-btn:hover { background: #f1f3f5; border-color: #adb5bd; }
        .toolbar-btn.active { background: #ebfbee; border-color: var(--primary); color: var(--primary); font-weight: 600; }

        /* í…Œì´ë¸” */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 980px; }
        th { background: #f8f9fa; padding: 10px 10px; text-align: left; border-bottom: 2px solid #e9ecef; color: #495057; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; white-space: nowrap; }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background: #e9ecef; }
        td { padding: 10px 10px; border-bottom: 1px solid #f1f3f5; vertical-align: top; }
        tr:hover td { background: #f8fff9; }

        /* ì—…ë¬´ë©”ëª¨ ì…€ â€” ì¤„ë°”ê¿ˆ í—ˆìš©, ìµœëŒ€ 3ì¤„ */
        td.content-cell {
            white-space: pre-wrap;
            word-break: break-word;
            max-width: 320px;
            line-height: 1.5;
        }
        /* ë¹„ê³  ì…€ â€” ì¢ê²Œ */
        td.memo-cell {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90px;
            color: #868e96;
            font-size: 12px;
        }

        /* ë°°ì§€ */
        .badge { padding: 4px 9px; border-radius: 5px; font-size: 11px; border: 1px solid transparent; display: inline-block; text-align: center; font-weight: 700; white-space: nowrap; }
        .badge-pending { background: #fff5f5; color: #fa5252; border-color: #ffc9c9; cursor: pointer; }
        .badge-pending:hover { background: #ffe3e3; }
        .badge-done { background: #ebfbee; color: #40c057; border-color: #b2f2bb; cursor: default; }
        .tag-req  { display:inline-block;background:#fff5f5;color:#fa5252;border:1px solid #ffc9c9;border-radius:4px;padding:1px 5px;font-size:10px;font-weight:700;margin-right:3px;vertical-align:middle; }
        .tag-opt  { display:inline-block;background:#f1f3f5;color:#868e96;border:1px solid #dee2e6;border-radius:4px;padding:1px 5px;font-size:10px;font-weight:600;margin-right:3px;vertical-align:middle; }

        /* ì•¡ì…˜ */
        .act-btn { background: none; border: 1.5px solid #dee2e6; border-radius: 5px; padding: 4px 8px; font-size: 11px; cursor: pointer; font-family: inherit; transition: all 0.15s; }
        .act-btn.edit { border-color: #74c0fc; color: #228be6; }
        .act-btn.edit:hover { background: #e7f5ff; }
        .act-btn.del { border-color: #ffc9c9; color: #fa5252; }
        .act-btn.del:hover { background: #fff5f5; }

        /* í˜ì´ì§€ë„¤ì´ì…˜ */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 4px; margin-top: 16px; flex-wrap: wrap; }
        .pg-btn { background: none; border: 1.5px solid #dee2e6; border-radius: 6px; padding: 5px 11px; font-size: 13px; cursor: pointer; color: #495057; font-family: inherit; transition: all 0.2s; min-width: 34px; }
        .pg-btn:hover:not(:disabled) { background: #f1f3f5; }
        .pg-btn.active { background: var(--primary); border-color: var(--primary); color: white; font-weight: 700; }
        .pg-btn:disabled { opacity: 0.35; cursor: not-allowed; }
        #pageInfo { text-align: center; font-size: 12px; color: #adb5bd; margin-top: 6px; }

        /* ëª¨ë‹¬ */
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 1000; justify-content: center; align-items: flex-start; padding-top: 50px; }
        .modal-bg.open { display: flex; }
        .modal { background: white; border-radius: 14px; padding: 26px; width: 92%; max-width: 560px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal h3 { margin: 0 0 18px; font-size: 17px; color: #343a40; display: flex; align-items: center; gap: 8px; }
        .modal-footer { display: flex; gap: 10px; margin-top: 18px; justify-content: flex-end; }
        .btn-cancel { background: #f1f3f5; border: none; border-radius: 8px; padding: 10px 20px; font-size: 14px; cursor: pointer; font-family: inherit; font-weight: 600; color: #495057; }
        .btn-cancel:hover { background: #e9ecef; }
        .btn-save { background: var(--primary); border: none; border-radius: 8px; padding: 10px 22px; font-size: 14px; cursor: pointer; font-family: inherit; font-weight: 700; color: white; }
        .btn-save:hover { background: var(--primary-hover); }

        /* ë¼ë””ì˜¤ */
        .radio-group { display: flex; align-items: center; gap: 14px; }
        .radio-label { display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; font-weight: 600; text-transform: none; letter-spacing: 0; color: #495057; }
        .radio-label input[type=radio] { width: auto; padding: 0; border: none; box-shadow: none; background: transparent; }

        /* ë””ë²„ê·¸ */
        #debugPanel { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px 16px; margin-top: 12px; display: none; }
        #debugPanel.visible { display: block; }
        #debugLog { max-height: 100px; overflow-y: auto; font-family: monospace; font-size: 11px; }
        .log-item { padding: 2px 0; border-bottom: 1px solid #e9ecef; }
        .log-ok { color: #40c057; } .log-err { color: #fa5252; } .log-info { color: #228be6; }
        #loading { text-align: center; padding: 20px; font-size: 14px; color: #868e96; display: none; }

        footer { text-align: center; padding: 20px 0 10px; font-size: 12px; color: #adb5bd; }
    </style>
</head>
<body>
<div id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• ìˆ˜ì • ëª¨ë‹¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="editModal">
    <div class="modal">
        <h3><i class="fas fa-pen" style="color:var(--primary);"></i> ì—…ë¬´ ìˆ˜ì •</h3>
        <input type="hidden" id="eRowNum">
        <div class="form-grid">
            <div class="input-group">
                <label>ê³µë¬¸ë²ˆí˜¸ <span style="opacity:.5;font-weight:400;">(ì„ íƒ)</span></label>
                <input type="text" id="eDocNum" placeholder="ì¤‘ë“±êµìœ¡ê³¼-001">
            </div>
            <div class="input-group">
                <label>ê³µë¬¸ì œëª© <span style="color:#fa5252;">*</span></label>
                <input type="text" id="eTitle">
            </div>
            <div class="input-group">
                <label>ì œì¶œë§ˆê°ì¼</label>
                <input type="date" id="eDueDate">
            </div>
            <div class="input-group">
                <label>ì œì¶œì¼(ì™„ë£Œ)</label>
                <input type="date" id="eSubmitDate">
            </div>
        </div>
        <div class="input-group" style="margin-top:12px;">
            <label style="display:flex;align-items:center;gap:12px;">
                ì—…ë¬´ë©”ëª¨ ë˜ëŠ” ì œì¶œë‚´ìš©
                <span class="radio-group">
                    <label class="radio-label" style="color:#495057;">
                        <input type="radio" name="eContentType" value="ì„ íƒ" checked
                            style="accent-color:var(--primary);"> ì„ íƒ
                    </label>
                    <label class="radio-label" style="color:#fa5252;">
                        <input type="radio" name="eContentType" value="í•„ìˆ˜"
                            style="accent-color:#fa5252;"> í•„ìˆ˜
                    </label>
                </span>
            </label>
            <textarea id="eContent" rows="3" placeholder="ì—…ë¬´ë©”ëª¨ ë˜ëŠ” ì œì¶œë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <input type="hidden" id="eContentType" value="ì„ íƒ">
        </div>
        <div class="input-group" style="margin-top:12px;">
            <label>ë¹„ê³ </label>
            <input type="text" id="eMemo" placeholder="ë©”ëª¨ (ì§§ê²Œ)">
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn-save" onclick="saveEdit()"><i class="fas fa-save"></i> ì €ì¥</button>
        </div>
    </div>
</div>

<div class="container">

    <!-- í—¤ë” -->
    <div class="page-header">
        <h1><i class="fas fa-calendar-check" style="margin-right:8px;"></i>ì—…ë¬´ ì¶”ì§„ ìŠ¤ì¼€ì¤„ëŸ¬</h1>
        <p>ì—…ë¬´ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
    </div>

    <!-- ì„¤ì • ì¹´ë“œ (ì ‘ì´ì‹) -->
    <div class="config-card" id="configCard">
        <h2><i class="fas fa-gear" style="color:#2f9e44;"></i> ì—°ê²° ì„¤ì •</h2>
        <div class="config-grid">
            <div class="config-input">
                <label>Google Apps Script URL</label>
                <!-- ì‚¬ìš©ìê°€ ìš”ì²­í•œ URLì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì • -->
                <input type="text" id="scriptUrl" value="https://script.google.com/macros/s/AKfycbxv4I0lCuyTw02DiuB_JQZ76j42y_fnkI1bVvQYZAXZ5XUZ7PdHJJ1fxOKAaGMzjFJW/exec">
            </div>
            <div style="display:flex;gap:8px;align-items:end;">
                <button class="toolbar-btn" onclick="saveConfig()"
                    style="background:#40c057;color:white;border-color:#40c057;padding:9px 18px;font-weight:700;">
                    <i class="fas fa-link"></i> ì €ì¥
                </button>
                <button class="toolbar-btn" onclick="toggleConfig()">
                    <i class="fas fa-eye-slash"></i> ë‹«ê¸°
                </button>
            </div>
        </div>
        <div class="config-note">
            <i class="fas fa-circle-info" style="color:#74c0fc;margin-top:1px;"></i>
            <span>ì„¤ì •í•œ URLì€ ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.</span>
        </div>
    </div>

    <!-- ë“±ë¡ ì¹´ë“œ -->
    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h2><i class="fas fa-plus-circle" style="color:var(--primary);"></i> ì‹ ê·œ ì—…ë¬´ ë“±ë¡</h2>
            <button class="toolbar-btn" onclick="toggleConfig()" style="font-size:11px;padding:4px 8px;">
                <i class="fas fa-gear"></i> ì„¤ì •
            </button>
        </div>
        <form id="scheduleForm">
            <div class="form-grid">
                <div class="input-group">
                    <label>ê³µë¬¸ë²ˆí˜¸ <span style="opacity:.5;font-weight:400;">(ì„ íƒ)</span></label>
                    <input type="text" id="docNum" name="docNum" placeholder="ì˜ˆ: ì¤‘ë“±êµìœ¡ê³¼-001">
                </div>
                <div class="input-group">
                    <label>ê³µë¬¸ì œëª© <span style="color:#fa5252;">*</span></label>
                    <input type="text" id="title" name="title" placeholder="ê³µë¬¸ ì œëª© ì…ë ¥" required>
                </div>
                <div class="input-group">
                    <label>ì œì¶œë§ˆê°ì¼ <span style="opacity:.5;font-weight:400;">(ì„ íƒ)</span></label>
                    <input type="date" id="dueDate" name="dueDate">
                </div>
                <div class="input-group">
                    <label>ë¹„ê³  <span style="opacity:.5;font-weight:400;">(ì„ íƒ)</span></label>
                    <input type="text" id="memo" name="memo" placeholder="ì§§ì€ ë©”ëª¨">
                </div>
            </div>
            <div class="input-group" style="margin-bottom:13px;">
                <label style="display:flex;align-items:center;gap:12px;">
                    ì—…ë¬´ë©”ëª¨ ë˜ëŠ” ì œì¶œë‚´ìš© <span style="opacity:.5;font-weight:400;font-size:11px;">(ì„ íƒ)</span>
                    <span class="radio-group">
                        <label class="radio-label" style="color:#495057;">
                            <input type="radio" name="contentType" id="ctOptional" value="ì„ íƒ" checked
                                style="accent-color:var(--primary);"> ì„ íƒ
                        </label>
                        <label class="radio-label" style="color:#fa5252;">
                            <input type="radio" name="contentType" id="ctRequired" value="í•„ìˆ˜"
                                style="accent-color:#fa5252;"> í•„ìˆ˜
                        </label>
                    </span>
                </label>
                <textarea id="content" name="content" rows="2" placeholder="ì—…ë¬´ë©”ëª¨ ë˜ëŠ” ì œì¶œë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                <input type="hidden" id="contentTypeVal" name="contentType" value="ì„ íƒ">
            </div>
            <button type="submit" id="submitBtn"><i class="fas fa-plus-circle"></i> ì—…ë¬´ ë“±ë¡í•˜ê¸°</button>
        </form>
        <div id="debugPanel"><strong style="font-size:12px;">ğŸ” í†µì‹  ë¡œê·¸</strong><div id="debugLog"></div></div>
    </div>

    <!-- í˜„í™© ì¹´ë“œ -->
    <div class="card">
        <div class="toolbar">
            <h2 style="margin:0;"><i class="fas fa-list-check" style="color:var(--primary);"></i> ì—…ë¬´ ì¶”ì§„ í˜„í™©</h2>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
                <button class="toolbar-btn active" id="filterAll" onclick="setFilter('all')">ì „ì²´</button>
                <button class="toolbar-btn" id="filterPending" onclick="setFilter('pending')">ë¯¸ì œì¶œ</button>
                <button class="toolbar-btn" id="filterDone" onclick="setFilter('done')">ì™„ë£Œ</button>
                <button class="toolbar-btn" onclick="fetchData()"><i class="fas fa-rotate-right"></i> ìƒˆë¡œê³ ì¹¨</button>
                <button class="toolbar-btn" id="debugBtn" onclick="toggleDebug()"><i class="fas fa-bug"></i></button>
            </div>
        </div>

        <!-- ê²€ìƒ‰ì°½ -->
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;">
            <div style="position:relative;flex:1;max-width:420px;">
                <i class="fas fa-magnifying-glass" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#adb5bd;font-size:14px;pointer-events:none;"></i>
                <input type="text" id="searchInput" placeholder="ê³µë¬¸ì œëª© ë˜ëŠ” ì—…ë¬´ë©”ëª¨ë¡œ ê²€ìƒ‰..."
                    style="padding:9px 12px 9px 36px;border:1.5px solid #dee2e6;border-radius:8px;font-size:14px;font-family:inherit;width:100%;background:#fafafa;transition:border-color 0.2s;"
                    oninput="onSearch()" onfocus="this.style.borderColor='#40c057'" onblur="this.style.borderColor='#dee2e6'">
            </div>
            <button onclick="clearSearch()" id="clearBtn"
                style="display:none;background:none;border:1.5px solid #ffc9c9;border-radius:8px;padding:8px 13px;font-size:13px;color:#fa5252;cursor:pointer;font-family:inherit;white-space:nowrap;">
                <i class="fas fa-xmark"></i> ì´ˆê¸°í™”
            </button>
            <span id="searchResult" style="font-size:12px;color:#868e96;white-space:nowrap;"></span>
        </div>
        <div id="loading"><i class="fas fa-spinner fa-spin"></i> ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th style="width:38px;text-align:center;">#</th>
                        <th style="width:120px;">ê³µë¬¸ë²ˆí˜¸</th>
                        <th style="min-width:160px;">ê³µë¬¸ì œëª©</th>
                        <th style="min-width:260px;">ì—…ë¬´ë©”ëª¨,ì œì¶œë‚´ìš©</th>
                        <th class="sortable" id="thDue" onclick="toggleSort()" style="width:115px;">
                            ì œì¶œë§ˆê°ì¼ <span id="sortIcon">â–²</span>
                        </th>
                        <th style="width:115px;">ì œì¶œì¼(ì™„ë£Œ)</th>
                        <th style="width:90px;">ë¹„ê³ </th>
                        <th style="width:80px;text-align:center;">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="tBody"></tbody>
            </table>
        </div>
        <div style="margin-top:8px;font-size:12px;color:#adb5bd;display:flex;align-items:center;gap:5px;">
            <i class="fas fa-circle-info" style="color:#74c0fc;"></i>
            ê³µë¬¸ì€ <strong style="color:#495057;">ì œì¶œë§ˆê°ì¼ ìˆœ</strong>ìœ¼ë¡œ ìë™ ì •ë ¬ë©ë‹ˆë‹¤. ë§ˆê°ì¼ í—¤ë” í´ë¦­ ì‹œ ì˜¤ë¦„ì°¨ìˆœ/ë‚´ë¦¼ì°¨ìˆœ ì „í™˜ë©ë‹ˆë‹¤.
        </div>
        <div class="pagination" id="pagination"></div>
        <div id="pageInfo"></div>
    </div>
</div>

<footer id="footerText">
    Developed by Choi Gwang-cheol of Gurye Middle School in 2026. All rights reserved.
</footer>

<script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì•± ìƒíƒœ ë° ì„¤ì •
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    // ê¸°ë³¸ URL (ì‚¬ìš©ìê°€ ì œê³µí•œ URL)
    const DEFAULT_URL = 'https://script.google.com/macros/s/AKfycbxv4I0lCuyTw02DiuB_JQZ76j42y_fnkI1bVvQYZAXZ5XUZ7PdHJJ1fxOKAaGMzjFJW/exec';
    
    // ì €ì¥ëœ URLì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì“°ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
    let SCRIPT_URL = localStorage.getItem('SCRIPT_URL') || DEFAULT_URL;

    const PAGE_SIZE = 15;
    let allData = [], filter = 'all', page = 1, sortDir = 'asc', dbgVisible = false, searchQuery = '';

    const $ = id => document.getElementById(id);
    const safe = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/'/g,"\\'");

    function toast(msg, type='') {
        const t = $('toast'); t.textContent = msg;
        t.className = type ? `show ${type}` : 'show';
        clearTimeout(t._t); t._t = setTimeout(()=>t.className='', 3200);
    }
    function log(msg, type='info') {
        const d = document.createElement('div');
        d.className = `log-item log-${type}`;
        d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        $('debugLog').prepend(d);
    }
    function toggleDebug() {
        dbgVisible=!dbgVisible;
        $('debugPanel').classList.toggle('visible',dbgVisible);
        $('debugBtn').classList.toggle('active',dbgVisible);
    }
    function isOk(r){ return r&&(r.status==='success'||r.result==='success'||r.ok===true); }

    /* â”€â”€ ì„¤ì • ê´€ë¦¬ â”€â”€ */
    function toggleConfig() {
        const card = $('configCard');
        if (card.style.display === 'none' || card.style.display === '') {
            card.style.display = 'block';
            $('scriptUrl').focus();
        } else {
            card.style.display = 'none';
        }
    }

    function saveConfig() {
        const url = $('scriptUrl').value.trim();
        if (!url) {
            toast('URLì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
            return;
        }
        SCRIPT_URL = url;
        localStorage.setItem('SCRIPT_URL', url);
        toast('âœ… ì„¤ì • ì €ì¥ ì™„ë£Œ!', 'success');
        toggleConfig();
        fetchData();
    }

    /* â”€â”€ ë¼ë””ì˜¤ ë™ê¸°í™” â”€â”€ */
    document.querySelectorAll('input[name="contentType"]').forEach(r=>
        r.addEventListener('change',()=>$('contentTypeVal').value=r.value));
    document.querySelectorAll('input[name="eContentType"]').forEach(r=>
        r.addEventListener('change',()=>$('eContentType').value=r.value));

    /* â”€â”€ JSONP â”€â”€ */
    function rpc(params, ms=15000) {
        return new Promise((res,rej)=>{
            if(!SCRIPT_URL) {
                rej(new Error('Script URL ë¯¸ì„¤ì •'));
                return;
            }
            const cb='cb_'+Date.now()+'_'+Math.floor(Math.random()*9999);
            const timer=setTimeout(()=>{cleanup();rej(new Error('ì‹œê°„ ì´ˆê³¼'));},ms);
            function cleanup(){clearTimeout(timer);delete window[cb];if(sc.parentNode)document.body.removeChild(sc);}
            window[cb]=d=>{cleanup();res(d);};
            const sc=document.createElement('script');
            let url=SCRIPT_URL+'?callback='+cb;
            for(const k in params) url+=`&${encodeURIComponent(k)}=${encodeURIComponent(params[k])}`;
            log(`â†’ ${params.action}`,'info');
            sc.src=url; sc.onerror=()=>{cleanup();rej(new Error('ë¡œë“œ ì‹¤íŒ¨'));};
            document.body.appendChild(sc);
        });
    }

    /* â”€â”€ í•„í„° / ì •ë ¬ â”€â”€ */
    function setFilter(f){
        filter=f; page=1;
        ['All','Pending','Done'].forEach(k=>$('filter'+k).classList.remove('active'));
        $('filter'+f[0].toUpperCase()+f.slice(1)).classList.add('active');
        render();
    }
    function toggleSort(){
        sortDir=sortDir==='asc'?'desc':'asc';
        $('sortIcon').textContent=sortDir==='asc'?'â–²':'â–¼';
        page=1; render();
    }

    /* â”€â”€ ê²€ìƒ‰ â”€â”€ */
    function onSearch(){
        searchQuery = $('searchInput').value.trim();
        $('clearBtn').style.display = searchQuery ? '' : 'none';
        page = 1;
        render();
    }
    function clearSearch(){
        $('searchInput').value = '';
        searchQuery = '';
        $('clearBtn').style.display = 'none';
        $('searchResult').textContent = '';
        page = 1;
        render();
    }

    function filtered(){
        let d=[...allData];
        if(filter==='pending') d=d.filter(r=>!r.submitDate||!r.submitDate.trim());
        if(filter==='done')    d=d.filter(r=>r.submitDate&&r.submitDate.trim());
        // ê²€ìƒ‰ í•„í„°
        if(searchQuery){
            const q=searchQuery.toLowerCase();
            d=d.filter(r=>
                (r.title||'').toLowerCase().includes(q) ||
                (r.content||'').toLowerCase().includes(q)
            );
        }
        d.sort((a,b)=>{
            const da=new Date(a.dueDate||'9999-12-31'),db=new Date(b.dueDate||'9999-12-31');
            return sortDir==='asc'?da-db:db-da;
        });
        return d;
    }

    /* â”€â”€ ë Œë” â”€â”€ */
    function render(){
        const tbody=$('tBody'); tbody.innerHTML='';
        const fd=filtered(), total=fd.length;
        const totalPg=Math.max(1,Math.ceil(total/PAGE_SIZE));
        if(page>totalPg) page=totalPg;
        const start=(page-1)*PAGE_SIZE;
        const chunk=fd.slice(start,start+PAGE_SIZE);

        if(total===0){
            tbody.innerHTML=`<tr><td colspan="8" style="text-align:center;color:#adb5bd;padding:36px;">
                <i class="fas fa-inbox" style="font-size:28px;display:block;margin-bottom:10px;"></i>
                í‘œì‹œí•  ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            $('pagination').innerHTML=''; $('pageInfo').textContent=''; return;
        }

        chunk.forEach((row,i)=>{
            const tr=document.createElement('tr');
            const done=row.submitDate&&row.submitDate.trim();
            let dueCss='';
            if(!done&&row.dueDate){
                const diff=(new Date(row.dueDate)-new Date())/86400000;
                dueCss=diff<0?'color:#e03131;font-weight:700;':diff<=3?'color:#f76707;font-weight:700;':'';
            }
            const isReq=(row.contentType==='í•„ìˆ˜');
            const tag=row.content
                ?(isReq?'<span class="tag-req">í•„ìˆ˜</span>':'<span class="tag-opt">ì„ íƒ</span>')
                :'';
            const contentHtml = row.content
                ? tag + (row.content.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/\n/g,'<br>'))
                : '-';

            tr.innerHTML=`
                <td style="color:#adb5bd;text-align:center;vertical-align:middle;">${start+i+1}</td>
                <td style="font-size:12px;color:#868e96;vertical-align:middle;">${safe(row.docNum)||'-'}</td>
                <td style="vertical-align:middle;"><strong>${safe(row.title)}</strong></td>
                <td class="content-cell">${contentHtml}</td>
                <td style="${dueCss}vertical-align:middle;">${row.dueDate||'-'}</td>
                <td style="vertical-align:middle;">${done
                    ?`<span class="badge badge-done"><i class="fas fa-check"></i> ${row.submitDate}</span>`
                    :`<button class="badge badge-pending" onclick="markDone(${row.rowNum},'${safe(row.title)}')"><i class="fas fa-clock"></i> ë¯¸ì œì¶œ</button>`}
                </td>
                <td class="memo-cell" title="${safe(row.memo)||''}">${safe(row.memo)||'-'}</td>
                <td style="text-align:center;vertical-align:middle;white-space:nowrap;">
                    <button class="act-btn edit" onclick="openEdit(${row.rowNum})"><i class="fas fa-pen"></i></button>
                    <button class="act-btn del" style="margin-left:3px;" onclick="delRow(${row.rowNum},'${safe(row.title)}')"><i class="fas fa-trash"></i></button>
                </td>`;
            tbody.appendChild(tr);
        });

        renderPg(totalPg);
        $('pageInfo').textContent=`ì „ì²´ ${total}ê±´ Â· ${start+1}â€“${Math.min(start+PAGE_SIZE,total)}ê±´ í‘œì‹œ`;
        if(searchQuery){
            $('searchResult').textContent=`"${searchQuery}" ê²€ìƒ‰ ê²°ê³¼ ${total}ê±´`;
        } else {
            $('searchResult').textContent='';
        }
    }

    function renderPg(total){
        const c=$('pagination'); c.innerHTML='';
        if(total<=1) return;
        const btn=(lbl,p,active,dis)=>{
            const b=document.createElement('button');
            b.className='pg-btn'+(active?' active':''); b.disabled=!!dis; b.innerHTML=lbl;
            if(!dis&&!active) b.onclick=()=>{
                page=p; render();
                $('tBody').closest('.card').scrollIntoView({behavior:'smooth',block:'start'});
            };
            return b;
        };
        c.appendChild(btn('<i class="fas fa-angle-left"></i>',page-1,false,page===1));
        let ps=[];
        if(total<=7){for(let i=1;i<=total;i++)ps.push(i);}
        else{
            ps=[1];
            if(page>3)ps.push('â€¦');
            for(let i=Math.max(2,page-1);i<=Math.min(total-1,page+1);i++)ps.push(i);
            if(page<total-2)ps.push('â€¦');
            ps.push(total);
        }
        ps.forEach(p=>{
            if(p==='â€¦'){const s=document.createElement('span');s.style.cssText='padding:0 4px;color:#adb5bd;font-size:13px;';s.textContent='â€¦';c.appendChild(s);}
            else c.appendChild(btn(p,p,p===page));
        });
        c.appendChild(btn('<i class="fas fa-angle-right"></i>',page+1,false,page===total));
    }

    /* â”€â”€ ë°ì´í„° ë¡œë“œ â”€â”€ */
    async function fetchData(goLast=false){
        $('loading').style.display='block';
        try{
            const data=await rpc({action:'read'});
            if(!Array.isArray(data)) throw new Error('ë°°ì—´ì´ ì•„ë‹Œ ì‘ë‹µ');
            allData=data; log(`${data.length}ê±´ ìˆ˜ì‹ `,'ok');
            if(goLast){
                const totalPg=Math.max(1,Math.ceil(filtered().length/PAGE_SIZE));
                page=totalPg;
            }
            render();
        }catch(e){
            log('ì¡°íšŒ ì‹¤íŒ¨: '+e.message,'err');
            $('tBody').innerHTML=`<tr><td colspan="8" style="text-align:center;color:#fa5252;padding:24px;">
                <i class="fas fa-triangle-exclamation"></i> ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨<br>
                <small style="color:#adb5bd;">${e.message}</small><br>
                <button onclick="toggleConfig()" style="margin-top:10px;border:1px solid #dee2e6;background:white;padding:4px 10px;border-radius:4px;cursor:pointer;">ì„¤ì • í™•ì¸</button></td></tr>`;
            toast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨','error');
            if(!dbgVisible) toggleDebug();
        }finally{$('loading').style.display='none';}
    }

    /* â”€â”€ ë“±ë¡ â”€â”€ */
    $('scheduleForm').onsubmit=async function(e){
        e.preventDefault();
        const btn=$('submitBtn'); btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> ì €ì¥ ì¤‘...';
        const p={action:'create'};
        new FormData(e.target).forEach((v,k)=>p[k]=v);
        try{
            const r=await rpc(p);
            toast(isOk(r)?'âœ… ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!':'ë“±ë¡ëì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',isOk(r)?'success':'');
            e.target.reset();
            $('ctOptional').checked=true; $('contentTypeVal').value='ì„ íƒ';
            await fetchData();
        }catch(err){toast('ë“±ë¡ ì‹¤íŒ¨: '+err.message,'error');if(!dbgVisible)toggleDebug();}
        finally{btn.disabled=false;btn.innerHTML='<i class="fas fa-plus-circle"></i> ì—…ë¬´ ë“±ë¡í•˜ê¸°';}
    };

    /* â”€â”€ ì œì¶œì¼ ì…ë ¥ â”€â”€ */
    async function markDone(rowNum,title){
        const today=new Date().toISOString().split('T')[0];
        const date=prompt(`[${title}]\nì œì¶œ ì™„ë£Œ ë‚ ì§œ ì…ë ¥ (YYYY-MM-DD)`,today);
        if(!date) return;
        if(!/^\d{4}-\d{2}-\d{2}$/.test(date)){toast('ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜','error');return;}
        try{
            const r=await rpc({action:'update',rowNum,submitDate:date});
            toast(isOk(r)?'âœ… ì œì¶œì¼ ê¸°ë¡!':'ì²˜ë¦¬ëì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',isOk(r)?'success':'');
            await fetchData();
        }catch(err){toast('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨','error');}
    }

    /* â”€â”€ ìˆ˜ì • ëª¨ë‹¬ â”€â”€ */
    function openEdit(rowNum){
        const row=allData.find(r=>r.rowNum===rowNum); if(!row) return;
        $('eRowNum').value=rowNum;
        $('eDocNum').value=row.docNum||'';
        $('eTitle').value=row.title||'';
        $('eDueDate').value=row.dueDate||'';
        $('eSubmitDate').value=row.submitDate||'';
        $('eContent').value=row.content||'';
        $('eMemo').value=row.memo||'';
        const ct=row.contentType||'ì„ íƒ';
        $('eContentType').value=ct;
        document.querySelectorAll('input[name="eContentType"]').forEach(r=>r.checked=(r.value===ct));
        $('editModal').classList.add('open');
    }
    function closeModal(){ $('editModal').classList.remove('open'); }
    $('editModal').addEventListener('click',e=>{ if(e.target===$('editModal')) closeModal(); });

    async function saveEdit(){
        const title=$('eTitle').value.trim();
        if(!title){toast('ê³µë¬¸ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.','error');return;}
        const p={action:'edit',rowNum:$('eRowNum').value,docNum:$('eDocNum').value.trim(),
            title,dueDate:$('eDueDate').value,submitDate:$('eSubmitDate').value,
            content:$('eContent').value.trim(),contentType:$('eContentType').value,
            memo:$('eMemo').value.trim()};
        closeModal();
        try{
            const r=await rpc(p);
            toast(isOk(r)?'âœ… ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!':'ìˆ˜ì •ëì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',isOk(r)?'success':'');
            await fetchData();
        }catch(err){toast('ìˆ˜ì • ì‹¤íŒ¨: '+err.message,'error');}
    }

    /* â”€â”€ ì‚­ì œ â”€â”€ */
    async function delRow(rowNum,title){
        if(!confirm(`[${title}]\nì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
        try{
            const r=await rpc({action:'delete',rowNum});
            toast(isOk(r)?'ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.':'ì‚­ì œëì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',isOk(r)?'success':'');
            await fetchData();
        }catch(err){toast('ì‚­ì œ ì‹¤íŒ¨','error');}
    }

    /* â”€â”€ ì´ˆê¸°í™” â”€â”€ */
    window.onload = function(){
        // ì…ë ¥ í•„ë“œì—ë„ ê°’ì„ ì±„ì›Œë‘ 
        $('scriptUrl').value = SCRIPT_URL;
        fetchData();
    };
</script>
</body>
</html>


